(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class d{constructor(e,t){this.handleInit=e,this.handleGameState=t,this.ws=null,window.addEventListener("beforeunload",()=>{this.ws&&this.ws.close()})}connect(e){this.ws=new WebSocket("ws://praven.kro.kr:5000"),this.ws.onopen=()=>{this.ws.send(JSON.stringify({type:"join",nickname:e}))},this.ws.onmessage=t=>{const i=JSON.parse(t.data);switch(i.type){case"init":this.playerId=i.id,this.handleInit(i);break;case"gameState":this.handleGameState(i);break}}}sendMove(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({id:this.playerId,type:"move",x:e.x,y:e.y}))}}class m{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.camera=t,this.setupCanvas()}setupCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,window.addEventListener("resize",()=>{const e=window.innerWidth-this.canvas.width,t=window.innerHeight-this.canvas.height;this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.camera.x-=e/2,this.camera.y-=t/2})}drawMap(e,t){if(!t||!t.width||!t.height)return;this.ctx.fillStyle="#1a1a1a";const i=-e.x,s=-e.y;this.ctx.fillRect(i,s,t.width,t.height),this.ctx.strokeStyle="#2a2a2a",this.ctx.lineWidth=1;for(let n=0;n<=t.width;n+=50)this.ctx.beginPath(),this.ctx.moveTo(i+n,s),this.ctx.lineTo(i+n,s+t.height),this.ctx.stroke();for(let n=0;n<=t.height;n+=50)this.ctx.beginPath(),this.ctx.moveTo(i,s+n),this.ctx.lineTo(i+t.width,s+n),this.ctx.stroke();this.ctx.strokeStyle="#3498db",this.ctx.lineWidth=2,this.ctx.strokeRect(i,s,t.width,t.height)}drawPlayer(e,t){const i=e.x-t.x,s=e.y-t.y;this.ctx.beginPath(),this.ctx.arc(i,s,20,0,Math.PI*2),this.ctx.fillStyle=e.color||"#ff0000",this.ctx.fill(),this.ctx.closePath(),this.ctx.font="16px Arial",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(e.name,i,s-30)}clear(){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class w{constructor(e){this.onLogin=e,this.element=document.getElementById("nicknameModal"),this.setupModal()}setupModal(){const e=this.element.querySelector("#nicknameInput"),t=this.element.querySelector("#startButton");t.onclick=()=>{const i=e.value.trim();i&&(this.element.style.display="none",this.onLogin(i))}}}class y{constructor(e){this.game=e,this.movement={up:!1,down:!1,left:!1,right:!1},this.moveSpeed=5,this.setupControls()}setupControls(){document.addEventListener("keydown",e=>{switch(e.key.toLowerCase()){case"w":this.movement.up=!0;break;case"s":this.movement.down=!0;break;case"a":this.movement.left=!0;break;case"d":this.movement.right=!0;break}}),document.addEventListener("keyup",e=>{switch(e.key.toLowerCase()){case"w":this.movement.up=!1;break;case"s":this.movement.down=!1;break;case"a":this.movement.left=!1;break;case"d":this.movement.right=!1;break}})}update(){let e=0,t=0;if(this.movement.up&&(t-=1),this.movement.down&&(t+=1),this.movement.left&&(e-=1),this.movement.right&&(e+=1),e!==0&&t!==0){const i=Math.sqrt(e*e+t*t);e=e/i,t=t/i}if(e!==0||t!==0){const i=this.game.camera.x+e*this.moveSpeed,s=this.game.camera.y+t*this.moveSpeed,n=i+window.innerWidth/2,a=s+window.innerHeight/2,h=n>=0&&n<=this.game.mapSize.width,o=a>=0&&a<=this.game.mapSize.height;h&&(this.game.camera.x=i),o&&(this.game.camera.y=s);const c=this.game.camera.x+window.innerWidth/2,l=this.game.camera.y+window.innerHeight/2;this.game.networkManager.sendMove({x:c,y:l})}}sendPositionToServer(e,t){(!this.lastSentTime||Date.now()-this.lastSentTime>=50)&&(this.game.networkManager.sendMove({x:e,y:t}),this.lastSentTime=Date.now())}}class f{constructor(){this.camera={x:0,y:0},this.renderer=new m(document.getElementById("gameCanvas"),this.camera),this.networkManager=new d(this.handleInit.bind(this),this.handleGameState.bind(this)),this.loginModal=new w(this.handleLogin.bind(this)),document.body.appendChild(this.loginModal.element),this.players=new Map,this.playerId=null,this.mapSize={width:0,height:0},this.playerController=new y(this)}handleInit(e){this.playerId=e.id,this.mapSize=e.mapSize;const t=e.gameState.players.find(i=>i.id===this.playerId);t&&(this.camera.x=t.x-window.innerWidth/2,this.camera.y=t.y-window.innerHeight/2),this.updatePlayers(e.gameState.players),this.startGameLoop()}handleGameState(e){this.updatePlayers(e.players)}handleLogin(e){this.networkManager.connect(e)}updatePlayers(e){this.players.clear(),e.forEach(t=>{this.players.set(t.id,t)})}startGameLoop(){const e=()=>{this.playerController.update(),this.renderer.clear(),this.renderer.drawMap(this.camera,this.mapSize);const t=this.players.get(this.playerId);t&&(t.x=this.camera.x+window.innerWidth/2,t.y=this.camera.y+window.innerHeight/2),this.players.forEach(i=>{this.renderer.drawPlayer(i,this.camera)}),requestAnimationFrame(e)};e()}}new f;
